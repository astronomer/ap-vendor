# Warning: automatically generated file
# Please edit .circleci/config.yml.j2, then run bin/generate_circleci_config.py
---
version: 2.1
orbs:
  python: circleci/python@2.0.3
workflows:
  version: 2.1
  vendor-build:
    jobs:
      - run_pre_commit

      - approve-alertmanager:
          type: approval
      - build:
          name: build-alertmanager
          directory: alertmanager
          requires:
            - approve-alertmanager
            - run_pre_commit
      - test:
          name: test-alertmanager
          directory: alertmanager
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-alertmanager
      - scan-trivy:
          name: scan-trivy-alertmanager
          directory: alertmanager
          requires:
            - test-alertmanager
      - release:
          name: release-alertmanager
          directory: alertmanager
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-alertmanager
          filters:
            branches:
              only: main

      - approve-auth-sidecar:
          type: approval
      - build:
          name: build-auth-sidecar
          directory: auth-sidecar
          requires:
            - approve-auth-sidecar
            - run_pre_commit
      - test:
          name: test-auth-sidecar
          directory: auth-sidecar
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-auth-sidecar
      - scan-trivy:
          name: scan-trivy-auth-sidecar
          directory: auth-sidecar
          requires:
            - test-auth-sidecar
      - release:
          name: release-auth-sidecar
          directory: auth-sidecar
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-auth-sidecar
          filters:
            branches:
              only: main

      - approve-awsesproxy:
          type: approval
      - build:
          name: build-awsesproxy
          directory: awsesproxy
          requires:
            - approve-awsesproxy
            - run_pre_commit
      - test:
          name: test-awsesproxy
          directory: awsesproxy
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-awsesproxy
      - scan-trivy:
          name: scan-trivy-awsesproxy
          directory: awsesproxy
          requires:
            - test-awsesproxy
      - release:
          name: release-awsesproxy
          directory: awsesproxy
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-awsesproxy
          filters:
            branches:
              only: main

      - approve-blackbox-exporter:
          type: approval
      - build:
          name: build-blackbox-exporter
          directory: blackbox-exporter
          requires:
            - approve-blackbox-exporter
            - run_pre_commit
      - test:
          name: test-blackbox-exporter
          directory: blackbox-exporter
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-blackbox-exporter
      - scan-trivy:
          name: scan-trivy-blackbox-exporter
          directory: blackbox-exporter
          requires:
            - test-blackbox-exporter
      - release:
          name: release-blackbox-exporter
          directory: blackbox-exporter
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-blackbox-exporter
          filters:
            branches:
              only: main

      - approve-configmap-reloader:
          type: approval
      - build:
          name: build-configmap-reloader
          directory: configmap-reloader
          requires:
            - approve-configmap-reloader
            - run_pre_commit
      - test:
          name: test-configmap-reloader
          directory: configmap-reloader
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-configmap-reloader
      - scan-trivy:
          name: scan-trivy-configmap-reloader
          directory: configmap-reloader
          requires:
            - test-configmap-reloader
      - release:
          name: release-configmap-reloader
          directory: configmap-reloader
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-configmap-reloader
          filters:
            branches:
              only: main

      - approve-curator:
          type: approval
      - build:
          name: build-curator
          directory: curator
          requires:
            - approve-curator
            - run_pre_commit
      - test:
          name: test-curator
          directory: curator
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-curator
      - scan-trivy:
          name: scan-trivy-curator
          directory: curator
          requires:
            - test-curator
      - release:
          name: release-curator
          directory: curator
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-curator
          filters:
            branches:
              only: main

      - approve-dind-golang:
          type: approval
      - build:
          name: build-dind-golang
          directory: dind-golang
          requires:
            - approve-dind-golang
            - run_pre_commit
      - test:
          name: test-dind-golang
          directory: dind-golang
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-dind-golang
      - scan-trivy:
          name: scan-trivy-dind-golang
          directory: dind-golang
          requires:
            - test-dind-golang
      - release:
          name: release-dind-golang
          directory: dind-golang
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-dind-golang
          filters:
            branches:
              only: main

      - approve-elasticsearch:
          type: approval
      - build:
          name: build-elasticsearch
          directory: elasticsearch
          requires:
            - approve-elasticsearch
            - run_pre_commit
      - test:
          name: test-elasticsearch
          directory: elasticsearch
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-elasticsearch
      - scan-trivy:
          name: scan-trivy-elasticsearch
          directory: elasticsearch
          requires:
            - test-elasticsearch
      - release:
          name: release-elasticsearch
          directory: elasticsearch
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-elasticsearch
          filters:
            branches:
              only: main

      - approve-elasticsearch-exporter:
          type: approval
      - build:
          name: build-elasticsearch-exporter
          directory: elasticsearch-exporter
          requires:
            - approve-elasticsearch-exporter
            - run_pre_commit
      - test:
          name: test-elasticsearch-exporter
          directory: elasticsearch-exporter
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-elasticsearch-exporter
      - scan-trivy:
          name: scan-trivy-elasticsearch-exporter
          directory: elasticsearch-exporter
          requires:
            - test-elasticsearch-exporter
      - release:
          name: release-elasticsearch-exporter
          directory: elasticsearch-exporter
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-elasticsearch-exporter
          filters:
            branches:
              only: main

      - approve-fluentd:
          type: approval
      - build:
          name: build-fluentd
          directory: fluentd
          requires:
            - approve-fluentd
            - run_pre_commit
      - test:
          name: test-fluentd
          directory: fluentd
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-fluentd
      - scan-trivy:
          name: scan-trivy-fluentd
          directory: fluentd
          requires:
            - test-fluentd
      - release:
          name: release-fluentd
          directory: fluentd
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-fluentd
          filters:
            branches:
              only: main

      - approve-git-daemon:
          type: approval
      - build:
          name: build-git-daemon
          directory: git-daemon
          requires:
            - approve-git-daemon
            - run_pre_commit
      - test:
          name: test-git-daemon
          directory: git-daemon
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-git-daemon
      - scan-trivy:
          name: scan-trivy-git-daemon
          directory: git-daemon
          requires:
            - test-git-daemon
      - release:
          name: release-git-daemon
          directory: git-daemon
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-git-daemon
          filters:
            branches:
              only: main

      - approve-git-sync:
          type: approval
      - build:
          name: build-git-sync
          directory: git-sync
          requires:
            - approve-git-sync
            - run_pre_commit
      - test:
          name: test-git-sync
          directory: git-sync
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-git-sync
      - scan-trivy:
          name: scan-trivy-git-sync
          directory: git-sync
          requires:
            - test-git-sync
      - release:
          name: release-git-sync
          directory: git-sync
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-git-sync
          filters:
            branches:
              only: main

      - approve-grafana:
          type: approval
      - build:
          name: build-grafana
          directory: grafana
          requires:
            - approve-grafana
            - run_pre_commit
      - test:
          name: test-grafana
          directory: grafana
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-grafana
      - scan-trivy:
          name: scan-trivy-grafana
          directory: grafana
          requires:
            - test-grafana
      - release:
          name: release-grafana
          directory: grafana
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-grafana
          filters:
            branches:
              only: main

      - approve-keda:
          type: approval
      - build:
          name: build-keda
          directory: keda
          requires:
            - approve-keda
            - run_pre_commit
      - test:
          name: test-keda
          directory: keda
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-keda
      - scan-trivy:
          name: scan-trivy-keda
          directory: keda
          requires:
            - test-keda
      - release:
          name: release-keda
          directory: keda
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-keda
          filters:
            branches:
              only: main

      - approve-keda-metrics-apiserver:
          type: approval
      - build:
          name: build-keda-metrics-apiserver
          directory: keda-metrics-apiserver
          requires:
            - approve-keda-metrics-apiserver
            - run_pre_commit
      - test:
          name: test-keda-metrics-apiserver
          directory: keda-metrics-apiserver
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-keda-metrics-apiserver
      - scan-trivy:
          name: scan-trivy-keda-metrics-apiserver
          directory: keda-metrics-apiserver
          requires:
            - test-keda-metrics-apiserver
      - release:
          name: release-keda-metrics-apiserver
          directory: keda-metrics-apiserver
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-keda-metrics-apiserver
          filters:
            branches:
              only: main

      - approve-kibana:
          type: approval
      - build:
          name: build-kibana
          directory: kibana
          requires:
            - approve-kibana
            - run_pre_commit
      - test:
          name: test-kibana
          directory: kibana
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-kibana
      - scan-trivy:
          name: scan-trivy-kibana
          directory: kibana
          requires:
            - test-kibana
      - release:
          name: release-kibana
          directory: kibana
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-kibana
          filters:
            branches:
              only: main

      - approve-kube-state:
          type: approval
      - build:
          name: build-kube-state
          directory: kube-state
          requires:
            - approve-kube-state
            - run_pre_commit
      - test:
          name: test-kube-state
          directory: kube-state
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-kube-state
      - scan-trivy:
          name: scan-trivy-kube-state
          directory: kube-state
          requires:
            - test-kube-state
      - release:
          name: release-kube-state
          directory: kube-state
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-kube-state
          filters:
            branches:
              only: main

      - approve-kubed:
          type: approval
      - build:
          name: build-kubed
          directory: kubed
          requires:
            - approve-kubed
            - run_pre_commit
      - test:
          name: test-kubed
          directory: kubed
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-kubed
      - scan-trivy:
          name: scan-trivy-kubed
          directory: kubed
          requires:
            - test-kubed
      - release:
          name: release-kubed
          directory: kubed
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-kubed
          filters:
            branches:
              only: main

      - approve-nats-exporter:
          type: approval
      - build:
          name: build-nats-exporter
          directory: nats-exporter
          requires:
            - approve-nats-exporter
            - run_pre_commit
      - test:
          name: test-nats-exporter
          directory: nats-exporter
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-nats-exporter
      - scan-trivy:
          name: scan-trivy-nats-exporter
          directory: nats-exporter
          requires:
            - test-nats-exporter
      - release:
          name: release-nats-exporter
          directory: nats-exporter
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-nats-exporter
          filters:
            branches:
              only: main

      - approve-nats-server:
          type: approval
      - build:
          name: build-nats-server
          directory: nats-server
          requires:
            - approve-nats-server
            - run_pre_commit
      - test:
          name: test-nats-server
          directory: nats-server
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-nats-server
      - scan-trivy:
          name: scan-trivy-nats-server
          directory: nats-server
          requires:
            - test-nats-server
      - release:
          name: release-nats-server
          directory: nats-server
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-nats-server
          filters:
            branches:
              only: main

      - approve-nats-streaming:
          type: approval
      - build:
          name: build-nats-streaming
          directory: nats-streaming
          requires:
            - approve-nats-streaming
            - run_pre_commit
      - test:
          name: test-nats-streaming
          directory: nats-streaming
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-nats-streaming
      - scan-trivy:
          name: scan-trivy-nats-streaming
          directory: nats-streaming
          requires:
            - test-nats-streaming
      - release:
          name: release-nats-streaming
          directory: nats-streaming
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-nats-streaming
          filters:
            branches:
              only: main

      - approve-nginx:
          type: approval
      - build:
          name: build-nginx
          directory: nginx
          requires:
            - approve-nginx
            - run_pre_commit
      - test:
          name: test-nginx
          directory: nginx
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-nginx
      - scan-trivy:
          name: scan-trivy-nginx
          directory: nginx
          requires:
            - test-nginx
      - release:
          name: release-nginx
          directory: nginx
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-nginx
          filters:
            branches:
              only: main

      - approve-nginx-es:
          type: approval
      - build:
          name: build-nginx-es
          directory: nginx-es
          requires:
            - approve-nginx-es
            - run_pre_commit
      - test:
          name: test-nginx-es
          directory: nginx-es
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-nginx-es
      - scan-trivy:
          name: scan-trivy-nginx-es
          directory: nginx-es
          requires:
            - test-nginx-es
      - release:
          name: release-nginx-es
          directory: nginx-es
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-nginx-es
          filters:
            branches:
              only: main

      - approve-node-exporter:
          type: approval
      - build:
          name: build-node-exporter
          directory: node-exporter
          requires:
            - approve-node-exporter
            - run_pre_commit
      - test:
          name: test-node-exporter
          directory: node-exporter
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-node-exporter
      - scan-trivy:
          name: scan-trivy-node-exporter
          directory: node-exporter
          requires:
            - test-node-exporter
      - release:
          name: release-node-exporter
          directory: node-exporter
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-node-exporter
          filters:
            branches:
              only: main

      - approve-openresty:
          type: approval
      - build:
          name: build-openresty
          directory: openresty
          requires:
            - approve-openresty
            - run_pre_commit
      - test:
          name: test-openresty
          directory: openresty
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-openresty
      - scan-trivy:
          name: scan-trivy-openresty
          directory: openresty
          requires:
            - test-openresty
      - release:
          name: release-openresty
          directory: openresty
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-openresty
          filters:
            branches:
              only: main

      - approve-pgbouncer:
          type: approval
      - build:
          name: build-pgbouncer
          directory: pgbouncer
          requires:
            - approve-pgbouncer
            - run_pre_commit
      - test:
          name: test-pgbouncer
          directory: pgbouncer
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-pgbouncer
      - scan-trivy:
          name: scan-trivy-pgbouncer
          directory: pgbouncer
          requires:
            - test-pgbouncer
      - release:
          name: release-pgbouncer
          directory: pgbouncer
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-pgbouncer
          filters:
            branches:
              only: main

      - approve-pgbouncer-exporter:
          type: approval
      - build:
          name: build-pgbouncer-exporter
          directory: pgbouncer-exporter
          requires:
            - approve-pgbouncer-exporter
            - run_pre_commit
      - test:
          name: test-pgbouncer-exporter
          directory: pgbouncer-exporter
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-pgbouncer-exporter
      - scan-trivy:
          name: scan-trivy-pgbouncer-exporter
          directory: pgbouncer-exporter
          requires:
            - test-pgbouncer-exporter
      - release:
          name: release-pgbouncer-exporter
          directory: pgbouncer-exporter
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-pgbouncer-exporter
          filters:
            branches:
              only: main

      - approve-postgres-exporter:
          type: approval
      - build:
          name: build-postgres-exporter
          directory: postgres-exporter
          requires:
            - approve-postgres-exporter
            - run_pre_commit
      - test:
          name: test-postgres-exporter
          directory: postgres-exporter
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-postgres-exporter
      - scan-trivy:
          name: scan-trivy-postgres-exporter
          directory: postgres-exporter
          requires:
            - test-postgres-exporter
      - release:
          name: release-postgres-exporter
          directory: postgres-exporter
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-postgres-exporter
          filters:
            branches:
              only: main

      - approve-postgres-operator:
          type: approval
      - build:
          name: build-postgres-operator
          directory: postgres-operator
          requires:
            - approve-postgres-operator
            - run_pre_commit
      - test:
          name: test-postgres-operator
          directory: postgres-operator
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-postgres-operator
      - scan-trivy:
          name: scan-trivy-postgres-operator
          directory: postgres-operator
          requires:
            - test-postgres-operator
      - release:
          name: release-postgres-operator
          directory: postgres-operator
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-postgres-operator
          filters:
            branches:
              only: main

      - approve-postgresql:
          type: approval
      - build:
          name: build-postgresql
          directory: postgresql
          requires:
            - approve-postgresql
            - run_pre_commit
      - test:
          name: test-postgresql
          directory: postgresql
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-postgresql
      - scan-trivy:
          name: scan-trivy-postgresql
          directory: postgresql
          requires:
            - test-postgresql
      - release:
          name: release-postgresql
          directory: postgresql
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-postgresql
          filters:
            branches:
              only: main

      - approve-prometheus:
          type: approval
      - build:
          name: build-prometheus
          directory: prometheus
          requires:
            - approve-prometheus
            - run_pre_commit
      - test:
          name: test-prometheus
          directory: prometheus
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-prometheus
      - scan-trivy:
          name: scan-trivy-prometheus
          directory: prometheus
          requires:
            - test-prometheus
      - release:
          name: release-prometheus
          directory: prometheus
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-prometheus
          filters:
            branches:
              only: main

      - approve-redis:
          type: approval
      - build:
          name: build-redis
          directory: redis
          requires:
            - approve-redis
            - run_pre_commit
      - test:
          name: test-redis
          directory: redis
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-redis
      - scan-trivy:
          name: scan-trivy-redis
          directory: redis
          requires:
            - test-redis
      - release:
          name: release-redis
          directory: redis
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-redis
          filters:
            branches:
              only: main

      - approve-registry:
          type: approval
      - build:
          name: build-registry
          directory: registry
          requires:
            - approve-registry
            - run_pre_commit
      - test:
          name: test-registry
          directory: registry
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-registry
      - scan-trivy:
          name: scan-trivy-registry
          directory: registry
          requires:
            - test-registry
      - release:
          name: release-registry
          directory: registry
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-registry
          filters:
            branches:
              only: main

      - approve-statsd-exporter:
          type: approval
      - build:
          name: build-statsd-exporter
          directory: statsd-exporter
          requires:
            - approve-statsd-exporter
            - run_pre_commit
      - test:
          name: test-statsd-exporter
          directory: statsd-exporter
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-statsd-exporter
      - scan-trivy:
          name: scan-trivy-statsd-exporter
          directory: statsd-exporter
          requires:
            - test-statsd-exporter
      - release:
          name: release-statsd-exporter
          directory: statsd-exporter
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-statsd-exporter
          filters:
            branches:
              only: main

      - approve-vector:
          type: approval
      - build:
          name: build-vector
          directory: vector
          requires:
            - approve-vector
            - run_pre_commit
      - test:
          name: test-vector
          directory: vector
          test_script: bin/test.py
          test_requirements: requirements/test-requirements.txt
          requires:
            - build-vector
      - scan-trivy:
          name: scan-trivy-vector
          directory: vector
          requires:
            - test-vector
      - release:
          name: release-vector
          directory: vector
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-vector
          filters:
            branches:
              only: main

jobs:
  run_pre_commit:
    docker:
      - image: quay.io/astronomer/ci-pre-commit:2022-01
    steps:
      - checkout
      - run:
          name: Create pre-commit-cache-key.txt
          command: |
            cp .pre-commit-config.yaml /tmp/pre-commit-cache-key.txt
            python --version --version | sed 's/^/# /' >> /tmp/pre-commit-cache-key.txt
      - restore_cache:
          keys:
            - pre-commit-cache-{{ checksum "/tmp/pre-commit-cache-key.txt" }}
      - run:
          name: Install pre-commit hooks
          command: pre-commit install-hooks
      - save_cache:
          key: pre-commit-cache-{{ checksum "/tmp/pre-commit-cache-key.txt" }}
          paths:
            - ~/.cache/pre-commit
      - run:
          name: Run pre-commit
          command: pre-commit run --all-files --show-diff-on-failure
  build:
    executor: docker-executor
    description: Build an image
    parameters:
      directory:
        description: "The directory of the image to build"
        type: string
    steps:
      - docker-build:
          image_name: ap-<< parameters.directory >>
          dockerfile: Dockerfile
          path: << parameters.directory >>
  test:
    executor: docker-executor
    description: "Test the docker image"
    parameters:
      directory:
        description: "The directory of the image to build"
        type: string
      test_script:
        description: "The pytest test script"
        type: string
      test_requirements:
        description: "The python requirement file."
        type: string
    steps:
      - docker-test:
          image_name: ap-<< parameters.directory >>
          path: << parameters.directory >>
          test_script: << parameters.test_script >>
          test_requirements: << parameters.test_requirements >>
  scan-trivy:
    docker:
      - image: docker:20.10.11-git
    description: "Trivy: Vulnerability scan a Docker image"
    parameters:
      directory:
        description: "The directory name of the image to be scanned"
        type: string
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
          version: 20.10.11
          image: aquasec/trivy:latest
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: Load archived Docker image
          command: |
            set -x
            docker load -i /tmp/workspace/ap-<< parameters.directory >>.tar
            docker images | grep ap-<< parameters.directory >>
      - run:
          name: Install trivy
          command: |
            apk add --update-cache --upgrade curl rpm bash
            curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/master/contrib/install.sh | sh -s -- -b /usr/local/bin
            date +%F > date
      - restore_cache:
          keys:
            - trivy-cache-{{ checksum "date" }}
      - run:
          name: Scan the local image with trivy
          command: bin/trivy-scan.sh "<< parameters.directory >>"
      - save_cache:
          key: trivy-cache-{{ checksum "date" }}
          paths:
            - /tmp/workspace/trivy-cache
  release:
    executor: docker-executor
    parameters:
      directory:
        description: "The directory name of the image to be scanned"
        type: string
    steps:
      - setup_remote_docker:
          docker_layer_caching: true
          version: 20.10.11
      - checkout
      - run:
          name: Validate semver tag
          command: |
            pip install packaging
            version="$(bin/check_version.py << parameters.directory >>)"
            echo "export TAG=${version}" >> $BASH_ENV
      - push-to-docker-hub:
          comma_separated_tags: "$TAG"
          image_name: ap-<< parameters.directory >>
      - push-to-quay-io:
          comma_separated_tags: "$TAG"
          image_name: ap-<< parameters.directory >>
executors:
  docker-executor:
    docker:
      - image: cimg/python:3.9
commands:
  docker-build:
    description: "Build a Docker image"
    parameters:
      dockerfile:
        type: string
        default: Dockerfile
      path:
        type: string
        default: "."
      image_name:
        type: string
        default: $CIRCLE_PROJECT_REPONAME
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
          version: 20.10.11
      - run:
          name: Build the Docker image
          command: bin/docker-build.sh << parameters.path>> << parameters.image_name >>
      - persist_to_workspace:
          root: .
          paths:
            - "./*.tar"
  docker-test:
    description: "Test a Docker image"
    parameters:
      path:
        type: string
        default: "."
      image_name:
        type: string
        default: $CIRCLE_PROJECT_REPONAME
      test_script:
        type: string
        default: bin/test.py
      test_requirements:
        type: string
        default: requirements/test-requirements.txt
    steps:
      - checkout
      - python/install-packages:
          pip-dependency-file: << parameters.test_requirements >>
          pkg-manager: pip
      - setup_remote_docker:
          docker_layer_caching: true
          version: 20.10.11
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: Load archived Docker image
          command: |
            set -x
            docker load -i /tmp/workspace/<< parameters.image_name >>.tar
            docker images | grep << parameters.image_name >>
      - run:
          name: Run Docker image test
          environment:
            ASTRO_IMAGE_NAME: << parameters.image_name >>
            ASTRO_IMAGE_TEST_CONFIG_PATH: << parameters.path >>/test.yaml
          command: |
            mkdir test-results
            pytest -v --junitxml=test-results/junit.xml << parameters.test_script>>
      - store_test_results:
          path: test-results
  push-to-quay-io:
    description: "Push a Docker image to Quay.io"
    parameters:
      comma_separated_tags:
        type: string
        default: $CIRCLE_BRANCH
      image_name:
        type: string
        default: $CIRCLE_PROJECT_REPONAME
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: Load archived Docker image
          command: |
            set -x
            docker load -i /tmp/workspace/<< parameters.image_name >>.tar
            docker images | grep << parameters.image_name >>
      - run:
          name: Login to Quay.io
          command: echo "$QUAY_PASSWORD" | docker login --username "$QUAY_USERNAME" --password-stdin quay.io
      - run:
          name: Push Docker image(s)
          command: bin/docker-push.sh "astronomer" "<< parameters.image_name >>" "<< parameters.comma_separated_tags >>" quay.io
  push-to-docker-hub:
    description: "Push a Docker image to DockerHub"
    parameters:
      comma_separated_tags:
        type: string
        default: $CIRCLE_BRANCH
      image_name:
        type: string
        default: $CIRCLE_PROJECT_REPONAME
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: Load archived Docker image
          command: docker load -i /tmp/workspace/<< parameters.image_name >>.tar
      - run:
          name: Login to DockerHub
          command: echo "$DOCKER_PASSWORD" | docker login --username $DOCKER_USERNAME --password-stdin docker.io
      - run:
          name: Push Docker image(s)
          command: bin/docker-push.sh "astronomerinc" "<< parameters.image_name >>" "<< parameters.comma_separated_tags >>" docker.io
